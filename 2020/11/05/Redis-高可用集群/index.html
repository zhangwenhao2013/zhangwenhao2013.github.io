<!DOCTYPE html>
<html lang="">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"zhangwenhao2013.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="哨兵模式的虽然解决了读写分离,以及Master宕机之后重新选举出新的Master来恢复Redis服务,但是选举恢复的过程耗时还是比较旧的,在生产上是难以接受.那有没有更好的解决办法呢?有那就是采用Cluster(集群),哨兵模式的不足是只有一个master,当master节点出现问题,整个Redis服务就陷入瘫痪状态.Cluster 集群就很好的解决了这个问题,一个Redis Cluster 部署">
<meta property="og:type" content="article">
<meta property="og:title" content="Redis 高可用集群">
<meta property="og:url" content="https://zhangwenhao2013.github.io/2020/11/05/Redis-%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4/index.html">
<meta property="og:site_name" content="老柯南">
<meta property="og:description" content="哨兵模式的虽然解决了读写分离,以及Master宕机之后重新选举出新的Master来恢复Redis服务,但是选举恢复的过程耗时还是比较旧的,在生产上是难以接受.那有没有更好的解决办法呢?有那就是采用Cluster(集群),哨兵模式的不足是只有一个master,当master节点出现问题,整个Redis服务就陷入瘫痪状态.Cluster 集群就很好的解决了这个问题,一个Redis Cluster 部署">
<meta property="og:locale">
<meta property="og:image" content="https://zhangwenhao2013.github.io/2020/11/05/Redis-%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4/cluster1.png">
<meta property="og:image" content="https://zhangwenhao2013.github.io/2020/11/05/Redis-%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4/2.png">
<meta property="article:published_time" content="2020-11-05T09:07:41.000Z">
<meta property="article:modified_time" content="2020-11-11T10:07:37.026Z">
<meta property="article:author" content="zhangwenhao">
<meta property="article:tag" content="REDIS">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://zhangwenhao2013.github.io/2020/11/05/Redis-%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4/cluster1.png">

<link rel="canonical" href="https://zhangwenhao2013.github.io/2020/11/05/Redis-%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'default'
  };
</script>

  <title>Redis 高可用集群 | 老柯南</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">老柯南</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">晴耕雨读</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="https://zhangwenhao2013.github.io/2020/11/05/Redis-%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="zhangwenhao">
      <meta itemprop="description" content="告诉自己可以做好，即使是新事物，也一样可以做好">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="老柯南">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Redis 高可用集群
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-11-05 17:07:41" itemprop="dateCreated datePublished" datetime="2020-11-05T17:07:41+08:00">2020-11-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-11-11 18:07:37" itemprop="dateModified" datetime="2020-11-11T18:07:37+08:00">2020-11-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/REDIS/" itemprop="url" rel="index"><span itemprop="name">REDIS</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>哨兵模式的虽然解决了读写分离,以及Master宕机之后重新选举出新的Master来恢复Redis服务,但是选举恢复的过程耗时还是比较旧的,在生产上是难以接受.那有没有更好的解决办法呢?<br>有那就是采用Cluster(集群),哨兵模式的不足是只有一个master,当master节点出现问题,整个Redis服务就陷入瘫痪状态.Cluster 集群就很好的解决了这个问题,一个Redis Cluster 部署多台Redis 主从服务. </p>
<p><img src="/2020/11/05/Redis-%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4/cluster1.png" alt="cluster"></p>
<a id="more"></a>


<h2 id="Redis-Cluster-节点通信机制"><a href="#Redis-Cluster-节点通信机制" class="headerlink" title="Redis Cluster 节点通信机制"></a>Redis Cluster 节点通信机制</h2><p>维护集群的元数据(集群节点信息,主从角色,节点数量,各节点共享的数据等)有两种方式:集中<br>式和gossip.</p>
<h3 id="集中式"><a href="#集中式" class="headerlink" title="集中式"></a>集中式</h3><p>优点在于元数据的更新和读取,时效性非常好,一旦元数据出现变更立即就会更新到集中式的存储中,其他节点读取的时候立即就可以立即感知到;不足在于所有的元数据的更新压力全部集中在一个地方,可能导致元数据的存储压力.很多中间件都会借助zookeeper集中式存储元数据.</p>
<h3 id="gossip-协议方式"><a href="#gossip-协议方式" class="headerlink" title="gossip 协议方式"></a>gossip 协议方式</h3><p>gossip协议包含多种消息,包括ping,pong,meet,fail等等。</p>
<ul>
<li><p>meet:某个节点发送meet给新加入的节点,让新节点加入集群中,然后新节点就会开始与其他节点进行通 信; </p>
</li>
<li><p>ping:每个节点都会频繁给其他节点发送ping,其中包含自己的状态还有自己维护的集群元数据，互相通过 ping交换元数据(类似自己感知到的集群节点增加和移除,hash slot信息等);</p>
</li>
<li><p>pong: 对ping和meet消息的返回,包含自己的状态和其他信息,也可以用于信息广播和更新; </p>
</li>
<li><p>fail: 某个节点判断另一个节点fail之后，就发送fail给其他节点,通知其他节点,指定的节点宕机了.</p>
</li>
</ul>
<p>gossip协议的优点在于元数据的更新比较分散,不是集中在一个地方,更新请求会陆陆续续,打到所有节点上 去更新,有一定的延时,降低了压力;缺点在于元数据更新有延时可能导致集群的一些操作会有一些滞后.</p>
<h4 id="gossip通信的10000端口"><a href="#gossip通信的10000端口" class="headerlink" title="gossip通信的10000端口"></a>gossip通信的10000端口</h4><p> 每个节点都有一个专门用于节点间gossip通信的端口,就是自己提供服务的端口号+10000,比如7001,那么 用于节点间通信的就是17001端口.每个节点每隔一段时间都会往另外几个节点发送ping消息,同时其他几点接收到ping消息之后返回pong消息.</p>
<h2 id="Redis-Cluster-原理"><a href="#Redis-Cluster-原理" class="headerlink" title="Redis Cluster 原理"></a>Redis Cluster 原理</h2><p>Redis Cluster 将所有的数据划分为 16384 (2^15 -1)个Slots, 每个Master负责一部分Slots.</p>
<p>Redis客户端拥有Redis集群的很多信息,比如 <strong>info</strong>命令中看到的,除了这些,Redis 客户端还会将同步Slots信息缓存起来.</p>
<h3 id="Slots计算"><a href="#Slots计算" class="headerlink" title="Slots计算"></a>Slots计算</h3><p>在执行存值操作的时候,默认会将key经过<strong>CRC16</strong>算法计算一个int值,再对16384 进行取模预算得到Slots信息. 这样就知道这个key 需要存储在哪台Master 节点上了.</p>
<p>及时出现: 客户端将key 发送到错误的Master节点上, 对应的Master节点发现,对应的Slot 不属于自己,会给客户端发送一个重定向,并提供key的Slot对应的正确Master 节点信息—— 跳转重定向.</p>
<h2 id="Redis-Cluster-搭建"><a href="#Redis-Cluster-搭建" class="headerlink" title="Redis Cluster 搭建"></a>Redis Cluster 搭建</h2><p>搭建 Redis Cluster, 每一个节点(不管是主,还是从)一开始都相当于Master,在扩容的时候也是一样,需要水平扩容的节点也是Master.</p>
<h3 id="搭建Redis-Cluster"><a href="#搭建Redis-Cluster" class="headerlink" title="搭建Redis Cluster"></a>搭建Redis Cluster</h3><p>这里我们创建一个包含 3个 一主一从的Redis 集群,3个主从服务分别位于不同的3个虚拟机上来实现分布式的效果.</p>
<h4 id="配置文件修改"><a href="#配置文件修改" class="headerlink" title="配置文件修改"></a>配置文件修改</h4><p>这里我们准备在3台机器上分别建好一个/clusterconfig的文件夹,假设服务器是 A,B,C </p>
<p>分别:</p>
<p> A  服务器: 创建两个端口 8001  8004</p>
<p> B  服务器: 创建两个端口 8002  8005</p>
<p> C  服务器: 创建两个端口 8003  8006</p>
<p> 每台机器上启动两个Redis服务. 分别是bindip:port.</p>
<p>接下来我们已其中一台为例,来设置配置，其他的只需要更加虚拟机ip,以及端口来更换就好了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">bind 172.30.60.2</span><br><span class="line"></span><br><span class="line">关闭保护模式</span><br><span class="line">protected-mode no</span><br><span class="line"></span><br><span class="line">port 8001</span><br><span class="line"></span><br><span class="line">开启守护模式</span><br><span class="line">daemonize yes</span><br><span class="line"></span><br><span class="line">这个也可以改成和端口一致</span><br><span class="line">pidfile &#x2F;var&#x2F;run&#x2F;redis_6379.pid</span><br><span class="line"></span><br><span class="line">文件存储路径</span><br><span class="line">dir &quot;&#x2F;usr&#x2F;local&#x2F;redis-5.0.2&#x2F;clusterconfigs&#x2F;8001&quot;</span><br><span class="line"></span><br><span class="line">密码设置</span><br><span class="line">masterauth zwh</span><br><span class="line">requirepass zwh</span><br><span class="line"></span><br><span class="line">开启aof</span><br><span class="line">appendonly yes</span><br><span class="line"></span><br><span class="line">集群配置：</span><br><span class="line">开启集群模式</span><br><span class="line">cluster-enabled yes</span><br><span class="line">cluster-config-file nodes-8001.conf</span><br><span class="line">cluster-node-timeout 5000</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="启动所有Redis-节点-并验证下进程"><a href="#启动所有Redis-节点-并验证下进程" class="headerlink" title="启动所有Redis 节点,并验证下进程"></a>启动所有Redis 节点,并验证下进程</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">redis-server redis.conf</span><br><span class="line"></span><br><span class="line">ps -ef | grep redis </span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@oldconan redis-5.0.2]# ps -ef |grep redis </span><br><span class="line">root       8902      1  0 15:34 ?        00:00:00 src&#x2F;redis-server 172.30.60.2:8001 [cluster]</span><br><span class="line">root       8907   8569  0 15:34 pts&#x2F;0    00:00:00 grep --color&#x3D;auto redis</span><br></pre></td></tr></table></figure>

<p>可以看到，redis.conf中开启了集群模式，进程中也会显示<strong>cluster</strong>;</p>
<h4 id="集群模式启动"><a href="#集群模式启动" class="headerlink" title="集群模式启动"></a>集群模式启动</h4><p>前面我们将6个Redis 节点都已经启动好了,现在他们是独立的Master节点,下面将启动集群模式.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">进入客户端</span><br><span class="line">dis-cli -a zwh --cluster create --cluster-replicas 1 172.30.60.2:8001 172.30.60.2:8004 172.30.60.3:8002 172.30.60.3:8005 172.30.60.4:8003 172.30.60.4:8006 </span><br></pre></td></tr></table></figure>

<p>这里有必要解释下这些参数的意思</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dis-cli -a password --cluster create --cluster-replicas count bindip:port ... bindip:port </span><br><span class="line"></span><br><span class="line">password : 密码</span><br><span class="line">count    : slave的数量</span><br></pre></td></tr></table></figure>

<p>Redis 自己设设定那个ip,port 是Master ,Slave ;并给每个Master <strong>分配 Slot</strong>, Slot的范围是 0 – 16383 ( 2^15 - 1);</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; Performing hash slots allocation on 6 nodes...</span><br><span class="line">Master[0] -&gt; Slots 0 - 5460</span><br><span class="line">Master[1] -&gt; Slots 5461 - 10922</span><br><span class="line">Master[2] -&gt; Slots 10923 - 16383</span><br><span class="line">Adding replica 172.30.60.3:8005 to 172.30.60.2:8001</span><br><span class="line">Adding replica 172.30.60.2:8004 to 172.30.60.3:8002</span><br><span class="line">Adding replica 172.30.60.4:8006 to 172.30.60.4:8003</span><br><span class="line">&gt;&gt;&gt; Trying to optimize slaves allocation for anti-affinity</span><br><span class="line">[OK] Perfect anti-affinity obtained!</span><br><span class="line">M: 4ec8e913999792fc2f3d056fcab6c8a73fc1858e 172.30.60.2:8001</span><br><span class="line">   slots:[0-5460] (5461 slots) master</span><br><span class="line">S: 9a8e6254af86f278d33108060ef1fac12e287bec 172.30.60.2:8004</span><br><span class="line">   replicates 23bfc097bf05021ef74e942bcd388d75a1ef2694</span><br><span class="line">M: ee77ad4c9b27e9b212ddf5f929c3cb895752a06a 172.30.60.3:8002</span><br><span class="line">   slots:[5461-10922] (5462 slots) master</span><br><span class="line">S: dfca9aff3abccba24483dce1efee76c8c8f2158f 172.30.60.3:8005</span><br><span class="line">   replicates 4ec8e913999792fc2f3d056fcab6c8a73fc1858e</span><br><span class="line">M: 23bfc097bf05021ef74e942bcd388d75a1ef2694 172.30.60.4:8003</span><br><span class="line">   slots:[10923-16383] (5461 slots) master</span><br><span class="line">S: 5f63eeb3e408b47d40862c16e39480832853daaf 172.30.60.4:8006</span><br><span class="line">   replicates ee77ad4c9b27e9b212ddf5f929c3cb895752a06a</span><br><span class="line">Can I set the above configuration? (type &#39;yes&#39; to accept):</span><br></pre></td></tr></table></figure>

<p>系统询问你是否 确认 slot 分配; 我们输入 <strong>yes</strong> 确认;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">Can I set the above configuration? (type &#39;yes&#39; to accept): yes</span><br><span class="line">&gt;&gt;&gt; Nodes configuration updated</span><br><span class="line">&gt;&gt;&gt; Assign a different config epoch to each node</span><br><span class="line">&gt;&gt;&gt; Sending CLUSTER MEET messages to join the cluster</span><br><span class="line">Waiting for the cluster to join</span><br><span class="line">...</span><br><span class="line">&gt;&gt;&gt; Performing Cluster Check (using node 172.30.60.2:8001)</span><br><span class="line">M: 4ec8e913999792fc2f3d056fcab6c8a73fc1858e 172.30.60.2:8001</span><br><span class="line">   slots:[0-5460] (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: dfca9aff3abccba24483dce1efee76c8c8f2158f 172.30.60.3:8005</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 4ec8e913999792fc2f3d056fcab6c8a73fc1858e</span><br><span class="line">M: 23bfc097bf05021ef74e942bcd388d75a1ef2694 172.30.60.4:8003</span><br><span class="line">   slots:[10923-16383] (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: 5f63eeb3e408b47d40862c16e39480832853daaf 172.30.60.4:8006</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates ee77ad4c9b27e9b212ddf5f929c3cb895752a06a</span><br><span class="line">M: ee77ad4c9b27e9b212ddf5f929c3cb895752a06a 172.30.60.3:8002</span><br><span class="line">   slots:[5461-10922] (5462 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: 9a8e6254af86f278d33108060ef1fac12e287bec 172.30.60.2:8004</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 23bfc097bf05021ef74e942bcd388d75a1ef2694</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line">&gt;&gt;&gt; Check for open slots...</span><br><span class="line">&gt;&gt;&gt; Check slots coverage...</span><br><span class="line">[OK] All 16384 slots covered.</span><br><span class="line">[root@oldconan redis-5.0.2]# </span><br></pre></td></tr></table></figure>

<p>到这里Redis 集群就已经创建完毕了, 我们可以进入任何一个节点,查看节点信息;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&gt;redis-cli -a zwh -h 172.30.60.2 -p 8001</span><br><span class="line"></span><br><span class="line">172.30.60.2:8001&gt;CLUSTER NODES</span><br><span class="line">b3e4648c23770c5f5271092ad14148eac4e7dd67 172.30.60.2:9000@19000 master - 0 1605061190568 0 connected</span><br><span class="line">23bfc097bf05021ef74e942bcd388d75a1ef2694 172.30.60.4:8003@18003 master - 0 1605061191000 5 connected 10923-16383</span><br><span class="line">5f63eeb3e408b47d40862c16e39480832853daaf 172.30.60.4:8006@18006 slave ee77ad4c9b27e9b212ddf5f929c3cb895752a06a 0 1605061190568 6 connected</span><br><span class="line">9a8e6254af86f278d33108060ef1fac12e287bec 172.30.60.2:8004@18004 slave 23bfc097bf05021ef74e942bcd388d75a1ef2694 0 1605061190000 5 connected</span><br><span class="line">ee77ad4c9b27e9b212ddf5f929c3cb895752a06a 172.30.60.3:8002@18002 myself,master - 0 1605061191000 3 connected 5461-10922</span><br><span class="line">4ec8e913999792fc2f3d056fcab6c8a73fc1858e 172.30.60.2:8001@18001 master - 0 1605061190000 1 connected 0-5460</span><br><span class="line">dfca9aff3abccba24483dce1efee76c8c8f2158f 172.30.60.3:8005@18005 slave 4ec8e913999792fc2f3d056fcab6c8a73fc1858e 0 1605061191776 4 connected</span><br></pre></td></tr></table></figure>

<p>从<strong>CLUSTER NODES</strong> 打印出来的信息,我们可以看到有3个Master,3个Slave;</p>
<p>有一点值得注意的是:</p>
<p>Redis 没有将我们创建在同一台机器上的两个端口设置为对应的 主从节点.而是错开到不同机器. 这是为了避免一台机器出现问题,导致集群一部分Slot全部访问不了.</p>
<h3 id="Redis-Cluster-水平扩容"><a href="#Redis-Cluster-水平扩容" class="headerlink" title="Redis Cluster 水平扩容"></a>Redis Cluster 水平扩容</h3><p>这里我们只准备扩容一对Master-slave,Redis Cluster 水平扩容 和前面一样,扩容的机器一开始也是Master ,实际扩容也最好将 两个节点设置在不同机器上.</p>
<p>这里我们在172.30.60.2的这台机器上创建了2个conf,准备将9000端口的配置作为Master ,9001端口的配置作为Slave;</p>
<ul>
<li>1:启动 1个需要扩容的Master Redis节点.</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-server 9000.conf</span><br></pre></td></tr></table></figure>

<ul>
<li>2: 将Master Redis节点 添加到Cluster中, 命令中是第一个ip是需要添加的节点ip和端口, 尾部ip和端口是 集群中任意一个节点的ip和端口.</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -a zwh --cluster add-node 172.30.60.2:9000 172.30.60.2:8001</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@oldconan redis-5.0.2]# src&#x2F;redis-cli -a zwh --cluster add-node 172.30.60.2:9000 172.30.60.2:8001</span><br><span class="line">Warning: Using a password with &#39;-a&#39; or &#39;-u&#39; option on the command line interface may not be safe.</span><br><span class="line">&gt;&gt;&gt; Adding node 172.30.60.2:9000 to cluster 172.30.60.2:8001</span><br><span class="line">&gt;&gt;&gt; Performing Cluster Check (using node 172.30.60.2:8001)</span><br><span class="line">M: 4ec8e913999792fc2f3d056fcab6c8a73fc1858e 172.30.60.2:8001</span><br><span class="line">   slots:[0-5460] (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: dfca9aff3abccba24483dce1efee76c8c8f2158f 172.30.60.3:8005</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 4ec8e913999792fc2f3d056fcab6c8a73fc1858e</span><br><span class="line">M: 23bfc097bf05021ef74e942bcd388d75a1ef2694 172.30.60.4:8003</span><br><span class="line">   slots:[10923-16383] (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: 5f63eeb3e408b47d40862c16e39480832853daaf 172.30.60.4:8006</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates ee77ad4c9b27e9b212ddf5f929c3cb895752a06a</span><br><span class="line">M: ee77ad4c9b27e9b212ddf5f929c3cb895752a06a 172.30.60.3:8002</span><br><span class="line">   slots:[5461-10922] (5462 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: 9a8e6254af86f278d33108060ef1fac12e287bec 172.30.60.2:8004</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 23bfc097bf05021ef74e942bcd388d75a1ef2694</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line">&gt;&gt;&gt; Check for open slots...</span><br><span class="line">&gt;&gt;&gt; Check slots coverage...</span><br><span class="line">[OK] All 16384 slots covered.</span><br><span class="line">&gt;&gt;&gt; Send CLUSTER MEET to node 172.30.60.2:9000 to make it join the cluster.</span><br><span class="line">[OK] New node added correctly.</span><br></pre></td></tr></table></figure>


<ul>
<li>3: 查看节点信息</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">172.30.60.3:8002&gt; CLUSTER NODES</span><br><span class="line">b3e4648c23770c5f5271092ad14148eac4e7dd67 172.30.60.2:9000@19000 master - 0 1605061190568 0 connected</span><br><span class="line">23bfc097bf05021ef74e942bcd388d75a1ef2694 172.30.60.4:8003@18003 master - 0 1605061191000 5 connected 10923-16383</span><br><span class="line">5f63eeb3e408b47d40862c16e39480832853daaf 172.30.60.4:8006@18006 slave ee77ad4c9b27e9b212ddf5f929c3cb895752a06a 0 1605061190568 6 connected</span><br><span class="line">9a8e6254af86f278d33108060ef1fac12e287bec 172.30.60.2:8004@18004 slave 23bfc097bf05021ef74e942bcd388d75a1ef2694 0 1605061190000 5 connected</span><br><span class="line">ee77ad4c9b27e9b212ddf5f929c3cb895752a06a 172.30.60.3:8002@18002 myself,master - 0 1605061191000 3 connected 5461-10922</span><br><span class="line">4ec8e913999792fc2f3d056fcab6c8a73fc1858e 172.30.60.2:8001@18001 master - 0 1605061190000 1 connected 0-5460</span><br><span class="line">dfca9aff3abccba24483dce1efee76c8c8f2158f 172.30.60.3:8005@18005 slave 4ec8e913999792fc2f3d056fcab6c8a73fc1858e 0 1605061191776 4 connected</span><br></pre></td></tr></table></figure>

<ul>
<li>4: 给新加入的Master 节点分配Slot</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">src&#x2F;redis-cli -a zwh --cluster reshard  172.30.60.2:8001</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@oldconan redis-5.0.2]# src&#x2F;redis-cli -a zwh --cluster reshard  172.30.60.2:8001</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Warning: Using a password with &#39;-a&#39; or &#39;-u&#39; option on the command line interface may not be safe.</span><br><span class="line">&gt;&gt;&gt; Performing Cluster Check (using node 172.30.60.2:8001)</span><br><span class="line">M: 4ec8e913999792fc2f3d056fcab6c8a73fc1858e 172.30.60.2:8001</span><br><span class="line">   slots:[0-5460] (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: dfca9aff3abccba24483dce1efee76c8c8f2158f 172.30.60.3:8005</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 4ec8e913999792fc2f3d056fcab6c8a73fc1858e</span><br><span class="line">M: b3e4648c23770c5f5271092ad14148eac4e7dd67 172.30.60.2:9000</span><br><span class="line">   slots: (0 slots) master</span><br><span class="line">M: 23bfc097bf05021ef74e942bcd388d75a1ef2694 172.30.60.4:8003</span><br><span class="line">   slots:[10923-16383] (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: 5f63eeb3e408b47d40862c16e39480832853daaf 172.30.60.4:8006</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates ee77ad4c9b27e9b212ddf5f929c3cb895752a06a</span><br><span class="line">M: ee77ad4c9b27e9b212ddf5f929c3cb895752a06a 172.30.60.3:8002</span><br><span class="line">   slots:[5461-10922] (5462 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: 9a8e6254af86f278d33108060ef1fac12e287bec 172.30.60.2:8004</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 23bfc097bf05021ef74e942bcd388d75a1ef2694</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line">&gt;&gt;&gt; Check for open slots...</span><br><span class="line">&gt;&gt;&gt; Check slots coverage...</span><br><span class="line">[OK] All 16384 slots covered.</span><br><span class="line">How many slots do you want to move (from 1 to 16384)? 300</span><br></pre></td></tr></table></figure>

<p>询问你需要给新添加的Master 分配多少Slot;  这里我们 分配300</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">What is the receiving node ID? b3e4648c23770c5f5271092ad14148eac4e7dd67</span><br><span class="line">Please enter all the source node IDs.</span><br><span class="line">  Type &#39;all&#39; to use all the nodes as source nodes for the hash slots.</span><br><span class="line">  Type &#39;done&#39; once you entered all the source nodes IDs.</span><br><span class="line">Source node #1: all</span><br></pre></td></tr></table></figure>
<p>询问你是从所有主节点瓜分 Slot 还是指定某一个id, 这里我们从所有Master节点各分配一点.</p>
<p>最终会输出很多分配记录. 我们可以进入某个节点,查看节点信息</p>
<ul>
<li>5:查看节点信息</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">172.30.60.3:8002&gt; CLUSTER NODES</span><br><span class="line">b3e4648c23770c5f5271092ad14148eac4e7dd67 172.30.60.2:9000@19000 master - 0 1605061330000 7 connected 0-98 5461-5561 10923-11021</span><br><span class="line">23bfc097bf05021ef74e942bcd388d75a1ef2694 172.30.60.4:8003@18003 master - 0 1605061331068 5 connected 11022-16383</span><br><span class="line">5f63eeb3e408b47d40862c16e39480832853daaf 172.30.60.4:8006@18006 slave ee77ad4c9b27e9b212ddf5f929c3cb895752a06a 0 1605061331575 6 connected</span><br><span class="line">9a8e6254af86f278d33108060ef1fac12e287bec 172.30.60.2:8004@18004 slave 23bfc097bf05021ef74e942bcd388d75a1ef2694 0 1605061330000 5 connected</span><br><span class="line">ee77ad4c9b27e9b212ddf5f929c3cb895752a06a 172.30.60.3:8002@18002 myself,master - 0 1605061330000 3 connected 5562-10922</span><br><span class="line">4ec8e913999792fc2f3d056fcab6c8a73fc1858e 172.30.60.2:8001@18001 master - 0 1605061330057 1 connected 99-5460</span><br><span class="line">dfca9aff3abccba24483dce1efee76c8c8f2158f 172.30.60.3:8005@18005 slave 4ec8e913999792fc2f3d056fcab6c8a73fc1858e 0 1605061330000 4 connected</span><br></pre></td></tr></table></figure>

<ul>
<li>6: 给新加入的Master 添加 Slave</li>
</ul>
<p>启动将作为 Slave 的Redis 9001服务;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-server 9001.conf</span><br></pre></td></tr></table></figure>

<p>将9001 节点添加到Redis 集群</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@oldconan redis-5.0.2]# src&#x2F;redis-cli -a zwh --cluster add-node 172.30.60.2:9001 172.30.60.2:8001</span><br><span class="line">Warning: Using a password with &#39;-a&#39; or &#39;-u&#39; option on the command line interface may not be safe.</span><br><span class="line">&gt;&gt;&gt; Adding node 172.30.60.2:9001 to cluster 172.30.60.2:8001</span><br><span class="line">&gt;&gt;&gt; Performing Cluster Check (using node 172.30.60.2:8001)</span><br><span class="line">M: 4ec8e913999792fc2f3d056fcab6c8a73fc1858e 172.30.60.2:8001</span><br><span class="line">   slots:[99-5460] (5362 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: dfca9aff3abccba24483dce1efee76c8c8f2158f 172.30.60.3:8005</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 4ec8e913999792fc2f3d056fcab6c8a73fc1858e</span><br><span class="line">M: b3e4648c23770c5f5271092ad14148eac4e7dd67 172.30.60.2:9000</span><br><span class="line">   slots:[0-98],[5461-5561],[10923-11021] (299 slots) master</span><br><span class="line">M: 23bfc097bf05021ef74e942bcd388d75a1ef2694 172.30.60.4:8003</span><br><span class="line">   slots:[11022-16383] (5362 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: 5f63eeb3e408b47d40862c16e39480832853daaf 172.30.60.4:8006</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates ee77ad4c9b27e9b212ddf5f929c3cb895752a06a</span><br><span class="line">M: ee77ad4c9b27e9b212ddf5f929c3cb895752a06a 172.30.60.3:8002</span><br><span class="line">   slots:[5562-10922] (5361 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: 9a8e6254af86f278d33108060ef1fac12e287bec 172.30.60.2:8004</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 23bfc097bf05021ef74e942bcd388d75a1ef2694</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line">&gt;&gt;&gt; Check for open slots...</span><br><span class="line">&gt;&gt;&gt; Check slots coverage...</span><br><span class="line">[OK] All 16384 slots covered.</span><br><span class="line">&gt;&gt;&gt; Send CLUSTER MEET to node 172.30.60.2:9001 to make it join the cluster.</span><br><span class="line">[OK] New node added correctly.</span><br></pre></td></tr></table></figure>

<p><strong>进入9000 Master 节点Redis 服务的客户端</strong>, 将9001 挂属给9000 Master.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">172.30.60.2:9000&gt; CLUSTER NODES</span><br><span class="line">9a8e6254af86f278d33108060ef1fac12e287bec 172.30.60.2:8004@18004 slave 23bfc097bf05021ef74e942bcd388d75a1ef2694 0 1605062137301 5 connected</span><br><span class="line">b3e4648c23770c5f5271092ad14148eac4e7dd67 172.30.60.2:9000@19000 myself,master - 0 1605062137000 7 connected 0-98 5461-5561 10923-11021</span><br><span class="line">4ec8e913999792fc2f3d056fcab6c8a73fc1858e 172.30.60.2:8001@18001 master - 0 1605062137000 1 connected 99-5460</span><br><span class="line">23bfc097bf05021ef74e942bcd388d75a1ef2694 172.30.60.4:8003@18003 master - 0 1605062137100 5 connected 11022-16383</span><br><span class="line">5f63eeb3e408b47d40862c16e39480832853daaf 172.30.60.4:8006@18006 slave ee77ad4c9b27e9b212ddf5f929c3cb895752a06a 0 1605062137806 3 connected</span><br><span class="line">dfca9aff3abccba24483dce1efee76c8c8f2158f 172.30.60.3:8005@18005 slave 4ec8e913999792fc2f3d056fcab6c8a73fc1858e 0 1605062138309 1 connected</span><br><span class="line">ee77ad4c9b27e9b212ddf5f929c3cb895752a06a 172.30.60.3:8002@18002 master - 0 1605062137503 3 connected 5562-10922</span><br><span class="line">6d4e86543b6ba652fe2f26bc0ca4c3de7c10cec4 172.30.60.2:9001@19001 master - 0 1605062136292 0 connected</span><br><span class="line">172.30.60.2:9000&gt; CLUSTER REPLICATE b3e4648c23770c5f5271092ad14148eac4e7dd67</span><br><span class="line">(error) ERR Can&#39;t replicate myself</span><br><span class="line">172.30.60.2:9000&gt; quit</span><br><span class="line">[root@xinyi redis-5.0.2]# src&#x2F;redis-cli -a zwh -h 172.30.60.2 -p 9001 </span><br><span class="line">Warning: Using a password with &#39;-a&#39; or &#39;-u&#39; option on the command line interface may not be safe.</span><br><span class="line">172.30.60.2:9001&gt; CLUSTER REPLICATE b3e4648c23770c5f5271092ad14148eac4e7dd67</span><br><span class="line">OK</span><br></pre></td></tr></table></figure>

<p>最后检查;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">172.30.60.2:9001&gt; CLUSTER NODES</span><br><span class="line">5f63eeb3e408b47d40862c16e39480832853daaf 172.30.60.4:8006@18006 slave ee77ad4c9b27e9b212ddf5f929c3cb895752a06a 0 1605062360209 3 connected</span><br><span class="line">dfca9aff3abccba24483dce1efee76c8c8f2158f 172.30.60.3:8005@18005 slave 4ec8e913999792fc2f3d056fcab6c8a73fc1858e 0 1605062359000 1 connected</span><br><span class="line">4ec8e913999792fc2f3d056fcab6c8a73fc1858e 172.30.60.2:8001@18001 master - 0 1605062359502 1 connected 99-5460</span><br><span class="line">23bfc097bf05021ef74e942bcd388d75a1ef2694 172.30.60.4:8003@18003 master - 0 1605062359000 5 connected 11022-16383</span><br><span class="line">ee77ad4c9b27e9b212ddf5f929c3cb895752a06a 172.30.60.3:8002@18002 master - 0 1605062359705 3 connected 5562-10922</span><br><span class="line">6d4e86543b6ba652fe2f26bc0ca4c3de7c10cec4 172.30.60.2:9001@19001 myself,slave b3e4648c23770c5f5271092ad14148eac4e7dd67 0 1605062358000 0 connected</span><br><span class="line">b3e4648c23770c5f5271092ad14148eac4e7dd67 172.30.60.2:9000@19000 master - 0 1605062360208 7 connected 0-98 5461-5561 10923-11021</span><br><span class="line">9a8e6254af86f278d33108060ef1fac12e287bec 172.30.60.2:8004@18004 slave 23bfc097bf05021ef74e942bcd388d75a1ef2694 0 1605062358594 5 connected</span><br></pre></td></tr></table></figure>


<h3 id="Redis-Cluster-移除扩容"><a href="#Redis-Cluster-移除扩容" class="headerlink" title="Redis Cluster 移除扩容"></a>Redis Cluster 移除扩容</h3><p>从水平扩容的流程可以推测出来,如果移除扩容,我们需要先将Slave节点移除, 再要移除Master 服务中存储的数据迁移,将Slot归还. 最后在移除Master节点.</p>
<p>1: 移除Slave节点</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">移除slave节点</span><br><span class="line">[root@xinyi redis-5.0.2]# src&#x2F;redis-cli -a zwh --cluster del-node 172.30.60.2:9001 6d4e86543b6ba652fe2f26bc0ca4c3de7c10cec4</span><br><span class="line"></span><br><span class="line">检查</span><br><span class="line">[root@xinyi redis-5.0.2]# src&#x2F;redis-cli -a zwh -h 172.30.60.2 -p 9000</span><br><span class="line">Warning: Using a password with &#39;-a&#39; or &#39;-u&#39; option on the command line interface may not be safe.</span><br><span class="line">172.30.60.2:9000&gt; CLUSTER NODES</span><br><span class="line">9a8e6254af86f278d33108060ef1fac12e287bec 172.30.60.2:8004@18004 slave 23bfc097bf05021ef74e942bcd388d75a1ef2694 0 1605082521974 5 connected</span><br><span class="line">b3e4648c23770c5f5271092ad14148eac4e7dd67 172.30.60.2:9000@19000 myself,master - 0 1605082521000 7 connected 0-98 5461-5561 10923-11021</span><br><span class="line">4ec8e913999792fc2f3d056fcab6c8a73fc1858e 172.30.60.2:8001@18001 master - 0 1605082521570 1 connected 99-5460</span><br><span class="line">23bfc097bf05021ef74e942bcd388d75a1ef2694 172.30.60.4:8003@18003 master - 0 1605082520964 5 connected 11022-16383</span><br><span class="line">5f63eeb3e408b47d40862c16e39480832853daaf 172.30.60.4:8006@18006 slave ee77ad4c9b27e9b212ddf5f929c3cb895752a06a 0 1605082521468 3 connected</span><br><span class="line">dfca9aff3abccba24483dce1efee76c8c8f2158f 172.30.60.3:8005@18005 slave 4ec8e913999792fc2f3d056fcab6c8a73fc1858e 0 1605082521000 1 connected</span><br><span class="line">ee77ad4c9b27e9b212ddf5f929c3cb895752a06a 172.30.60.3:8002@18002 master - 0 1605082522477 3 connected 5562-10922</span><br><span class="line">172.30.60.2:9000&gt; </span><br></pre></td></tr></table></figure>

<p>2:迁移数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">src&#x2F;redis-cli -a zwh --cluster reshard  172.30.60.2:9001</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">[root@xinyi redis-5.0.2]# src&#x2F;redis-cli -a zwh --cluster reshard 172.30.60.2:9000</span><br><span class="line">Warning: Using a password with &#39;-a&#39; or &#39;-u&#39; option on the command line interface may not be safe.</span><br><span class="line">&gt;&gt;&gt; Performing Cluster Check (using node 172.30.60.2:9000)</span><br><span class="line">M: b3e4648c23770c5f5271092ad14148eac4e7dd67 172.30.60.2:9000</span><br><span class="line">   slots:[0-98],[5461-5561],[10923-11021] (299 slots) master</span><br><span class="line">S: 9a8e6254af86f278d33108060ef1fac12e287bec 172.30.60.2:8004</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 23bfc097bf05021ef74e942bcd388d75a1ef2694</span><br><span class="line">M: 4ec8e913999792fc2f3d056fcab6c8a73fc1858e 172.30.60.2:8001</span><br><span class="line">   slots:[99-5460] (5362 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">M: 23bfc097bf05021ef74e942bcd388d75a1ef2694 172.30.60.4:8003</span><br><span class="line">   slots:[11022-16383] (5362 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: 5f63eeb3e408b47d40862c16e39480832853daaf 172.30.60.4:8006</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates ee77ad4c9b27e9b212ddf5f929c3cb895752a06a</span><br><span class="line">S: dfca9aff3abccba24483dce1efee76c8c8f2158f 172.30.60.3:8005</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 4ec8e913999792fc2f3d056fcab6c8a73fc1858e</span><br><span class="line">M: ee77ad4c9b27e9b212ddf5f929c3cb895752a06a 172.30.60.3:8002</span><br><span class="line">   slots:[5562-10922] (5361 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line">&gt;&gt;&gt; Check for open slots...</span><br><span class="line">&gt;&gt;&gt; Check slots coverage...</span><br><span class="line">[OK] All 16384 slots covered.</span><br><span class="line">How many slots do you want to move (from 1 to 16384)? 300</span><br><span class="line">What is the receiving node ID? ee77ad4c9b27e9b212ddf5f929c3cb895752a06a</span><br><span class="line">Please enter all the source node IDs.</span><br><span class="line">  Type &#39;all&#39; to use all the nodes as source nodes for the hash slots.</span><br><span class="line">  Type &#39;done&#39; once you entered all the source nodes IDs.</span><br><span class="line">Source node #1: b3e4648c23770c5f5271092ad14148eac4e7dd67</span><br><span class="line">Source node #2: done</span><br><span class="line"></span><br><span class="line">Ready to move 300 slots.</span><br><span class="line">  Source nodes:</span><br><span class="line">    M: b3e4648c23770c5f5271092ad14148eac4e7dd67 172.30.60.2:9000</span><br><span class="line">       slots:[0-98],[5461-5561],[10923-11021] (299 slots) master</span><br><span class="line">  Destination node:</span><br><span class="line">    M: ee77ad4c9b27e9b212ddf5f929c3cb895752a06a 172.30.60.3:8002</span><br><span class="line">       slots:[5562-10922] (5361 slots) master</span><br><span class="line">       1 additional replica(s)</span><br><span class="line">  Resharding plan:</span><br><span class="line">    Moving slot 0 from b3e4648c23770c5f5271092ad14148eac4e7dd67</span><br><span class="line">    Moving slot 1 from b3e4648c23770c5f5271092ad14148eac4e7dd67</span><br><span class="line">    Moving slot 2 from b3e4648c23770c5f5271092ad14148eac4e7dd67</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    最后输入 yes 确认计划</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>检查Slot 信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">172.30.60.2:8001&gt; CLUSTER NODES</span><br><span class="line">dfca9aff3abccba24483dce1efee76c8c8f2158f 172.30.60.3:8005@18005 slave 4ec8e913999792fc2f3d056fcab6c8a73fc1858e 0 1605082815692 4 connected</span><br><span class="line">4ec8e913999792fc2f3d056fcab6c8a73fc1858e 172.30.60.2:8001@18001 myself,master - 0 1605082815000 1 connected 99-5460</span><br><span class="line">b3e4648c23770c5f5271092ad14148eac4e7dd67 172.30.60.2:9000@19000 master - 0 1605082816501 7 connected</span><br><span class="line">23bfc097bf05021ef74e942bcd388d75a1ef2694 172.30.60.4:8003@18003 master - 0 1605082816704 5 connected 11022-16383</span><br><span class="line">5f63eeb3e408b47d40862c16e39480832853daaf 172.30.60.4:8006@18006 slave ee77ad4c9b27e9b212ddf5f929c3cb895752a06a 0 1605082815000 8 connected</span><br><span class="line">ee77ad4c9b27e9b212ddf5f929c3cb895752a06a 172.30.60.3:8002@18002 master - 0 1605082816198 8 connected 0-98 5461-11021</span><br><span class="line">9a8e6254af86f278d33108060ef1fac12e287bec 172.30.60.2:8004@18004 slave 23bfc097bf05021ef74e942bcd388d75a1ef2694 0 1605082816000 5 connected</span><br><span class="line">172.30.60.2:8001&gt; quit</span><br></pre></td></tr></table></figure>

<p>可以看到9000 节点后面没有Slot信息了.</p>
<p>3:删除Master</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">src&#x2F;redis-cli -a zwh --cluster del-node 172.30.60.2:9000 b3e4648c23770c5f5271092ad14148eac4e7dd67</span><br></pre></td></tr></table></figure>

<p>检查节点</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@xinyi redis-5.0.2]# src&#x2F;redis-cli -a zwh --cluster del-node 172.30.60.2:9000 b3e4648c23770c5f5271092ad14148eac4e7dd67</span><br><span class="line">Warning: Using a password with &#39;-a&#39; or &#39;-u&#39; option on the command line interface may not be safe.</span><br><span class="line">&gt;&gt;&gt; Removing node b3e4648c23770c5f5271092ad14148eac4e7dd67 from cluster 172.30.60.2:9000</span><br><span class="line">&gt;&gt;&gt; Sending CLUSTER FORGET messages to the cluster...</span><br><span class="line">&gt;&gt;&gt; SHUTDOWN the node.</span><br><span class="line">[root@xinyi redis-5.0.2]# src&#x2F;redis-cli -a zwh -h 172.30.60.2 -p 8001</span><br><span class="line">Warning: Using a password with &#39;-a&#39; or &#39;-u&#39; option on the command line interface may not be safe.</span><br><span class="line">172.30.60.2:8001&gt; CLUSTER NODES</span><br><span class="line">dfca9aff3abccba24483dce1efee76c8c8f2158f 172.30.60.3:8005@18005 slave 4ec8e913999792fc2f3d056fcab6c8a73fc1858e 0 1605082892917 4 connected</span><br><span class="line">4ec8e913999792fc2f3d056fcab6c8a73fc1858e 172.30.60.2:8001@18001 myself,master - 0 1605082892000 1 connected 99-5460</span><br><span class="line">23bfc097bf05021ef74e942bcd388d75a1ef2694 172.30.60.4:8003@18003 master - 0 1605082892000 5 connected 11022-16383</span><br><span class="line">5f63eeb3e408b47d40862c16e39480832853daaf 172.30.60.4:8006@18006 slave ee77ad4c9b27e9b212ddf5f929c3cb895752a06a 0 1605082891405 8 connected</span><br><span class="line">ee77ad4c9b27e9b212ddf5f929c3cb895752a06a 172.30.60.3:8002@18002 master - 0 1605082893421 8 connected 0-98 5461-11021</span><br><span class="line">9a8e6254af86f278d33108060ef1fac12e287bec 172.30.60.2:8004@18004 slave 23bfc097bf05021ef74e942bcd388d75a1ef2694 0 1605082892412 5 connected</span><br><span class="line">172.30.60.2:8001&gt; </span><br></pre></td></tr></table></figure>

<h2 id="Redis-Cluster-小知识"><a href="#Redis-Cluster-小知识" class="headerlink" title="Redis Cluster 小知识"></a>Redis Cluster 小知识</h2><h3 id="Redis-集群选举原理"><a href="#Redis-集群选举原理" class="headerlink" title="Redis 集群选举原理"></a>Redis 集群选举原理</h3><p>当Slave发现自己的Master变为 <strong>FAIL</strong>(gossip)时,Slave会尝试 <strong>FailOver</strong> 欲成为新的Master, 但是因为Master 可能拥有多个 Slave, 次数就需要进行选举了.</p>
<h4 id="选举"><a href="#选举" class="headerlink" title="选举"></a>选举</h4><ul>
<li><p>发现自己的Master 变为Fail,通gossip方式其他节点也会知道该Master已经出现故障.</p>
</li>
<li><p>记录自己选举次数 currentEpoch(新纪元) ,  currentEpoch +1, 并广播FAILOVER_AUTH_REQUEST给所有节点,尝试获取选票.</p>
</li>
<li><p>只有Master 节点才响应 FAILOVER_AUTH_REQUEST 广播.并检验其合法性,并Master会响应一个FAILOVER_AUTH_ACK, 一次currentEpoch Master只会响应一次FAILOVER_AUTH_REQUEST广播(只投一票)</p>
</li>
<li><p>Slave 统计收到的 FAILOVER_AUTH_ACK ,如果超过半数(Master),就直接晋升为新Master.并广播(PONG)通知其他集群节点,自己晋升为Master了.</p>
</li>
<li><p>如果没超过半数,继续进入下一轮选举,currentEpoch再 + 1;</p>
</li>
</ul>
<h4 id="发起FAILOVER-AUTH-REQUEST广播的时机"><a href="#发起FAILOVER-AUTH-REQUEST广播的时机" class="headerlink" title="发起FAILOVER_AUTH_REQUEST广播的时机"></a>发起FAILOVER_AUTH_REQUEST广播的时机</h4><p>当Slave发现自己的 Master 变为Fail时, 不会立马发起选举, 一部分原因是因为gossip协议,让其他节点感知到该Master 已经Fail(和后续验证合法性有关,当其他节点没意识到该Master节点Fail时,当收到选举广播,会拒绝投票),而是延时一定的时间之后再发起选举.</p>
<p>延时计算公式:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Delay &#x3D; 500ms + random (0 ~ 500ms) + SLAVE_RANK * 1000ms </span><br></pre></td></tr></table></figure>

<ul>
<li><p>其中SLAVE_RANK表示 Slave节点需要从总Master同步的数据总量,SLAVE_RANK 约下表示需要同步的数据越少,说明Slave 的数据越接近Master, 这种Slave 如果晋升为Master 需要同步的数据最少. Redis 更倾向于将这种Salve 晋升为Master ;</p>
</li>
<li><p>当存在多个Slave的SLAVE_RANK 一样,此时就需要拼<strong>random</strong>了.</p>
</li>
</ul>
<h3 id="Redis-避免脑裂问题"><a href="#Redis-避免脑裂问题" class="headerlink" title="Redis 避免脑裂问题"></a>Redis 避免脑裂问题</h3><p>脑裂问题: 同时存在多个Master,让客户端不知道该选择哪个Master.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">min‐slaves‐to‐write 1</span><br></pre></td></tr></table></figure>

<p>打个比方来说:</p>
<p>当Slot信息确定了,对应的key-value需要存储到某个IP:PORT的Master节点上,但是因为网络波动,导致这个节点同时出现了多个Master,导致存值出现问题.</p>
<p>和主从模式一样,我们可以设置超时时间<strong>cluster­node­timeout</strong>,不然集群那么迅速的选举.</p>
<p>还可以通过设置<strong>min‐slaves‐to‐write 1</strong>:表示只有Master 上面至少有一个从节点才认为其是Master.</p>
<p><img src="/2020/11/05/Redis-%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4/2.png" alt="脑裂"></p>
<p>当出现网络波动,网络瞬断, 导致Slave 晋升为Master ,当网络恢复正常 及时原来的 Master 恢复,在设置了<strong>min‐slaves‐to‐write</strong> 配置的情况下,因为原来的Master 已经没有Slave了,就不会认为其是Master,而会选择<strong>新的Master</strong>,原master 加入集群也将变为Slave.</p>
<h3 id="Redis-Cluster-至少需要3个Master节点-并且推荐节点数为奇数"><a href="#Redis-Cluster-至少需要3个Master节点-并且推荐节点数为奇数" class="headerlink" title="Redis Cluster 至少需要3个Master节点,并且推荐节点数为奇数"></a>Redis Cluster 至少需要3个Master节点,并且推荐节点数为奇数</h3><p>我们知道集群选举,选出新的Master  需要其他Master的 ACK 数量超过半数,所以需要满足大于等于3个节点的时候,当其中一个Master出现问题,选举才能进行的下去.</p>
<p>所谓的推荐<strong>节点数为奇数(2n+1)</strong>,是相对于偶数(2n+2)来比较的;</p>
<p>这里我们就以 5台 和  6台 来说;</p>
<p>如果6台Master节点,当挂了 1或者2 台Master时. 选举都能选出新的Master,尽量维持6台Master的局面;</p>
<p>如果是5台呢? 是不是也能达到这种效果,而且还可以少一台机器,所以推荐使用奇数个节点是在节省机器资源的情况下给出的结论.</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/REDIS/" rel="tag"># REDIS</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/11/04/Redis%E6%8C%81%E4%B9%85%E5%8C%96%E5%92%8C%E4%B8%BB%E4%BB%8E%E6%A8%A1%E5%BC%8F%E5%92%8C%E5%93%A8%E5%85%B5%E6%A8%A1%E5%BC%8F/" rel="prev" title="Redis持久化和主从模式和哨兵模式">
      <i class="fa fa-chevron-left"></i> Redis持久化和主从模式和哨兵模式
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/11/16/Zookeeper%E6%90%AD%E5%BB%BA%E5%92%8C%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/" rel="next" title="ZooKeeper搭建和简单使用">
      ZooKeeper搭建和简单使用 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Redis-Cluster-%E8%8A%82%E7%82%B9%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6"><span class="nav-number">1.</span> <span class="nav-text">Redis Cluster 节点通信机制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9B%86%E4%B8%AD%E5%BC%8F"><span class="nav-number">1.1.</span> <span class="nav-text">集中式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#gossip-%E5%8D%8F%E8%AE%AE%E6%96%B9%E5%BC%8F"><span class="nav-number">1.2.</span> <span class="nav-text">gossip 协议方式</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#gossip%E9%80%9A%E4%BF%A1%E7%9A%8410000%E7%AB%AF%E5%8F%A3"><span class="nav-number">1.2.1.</span> <span class="nav-text">gossip通信的10000端口</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Redis-Cluster-%E5%8E%9F%E7%90%86"><span class="nav-number">2.</span> <span class="nav-text">Redis Cluster 原理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Slots%E8%AE%A1%E7%AE%97"><span class="nav-number">2.1.</span> <span class="nav-text">Slots计算</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Redis-Cluster-%E6%90%AD%E5%BB%BA"><span class="nav-number">3.</span> <span class="nav-text">Redis Cluster 搭建</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%90%AD%E5%BB%BARedis-Cluster"><span class="nav-number">3.1.</span> <span class="nav-text">搭建Redis Cluster</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%BF%AE%E6%94%B9"><span class="nav-number">3.1.1.</span> <span class="nav-text">配置文件修改</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8%E6%89%80%E6%9C%89Redis-%E8%8A%82%E7%82%B9-%E5%B9%B6%E9%AA%8C%E8%AF%81%E4%B8%8B%E8%BF%9B%E7%A8%8B"><span class="nav-number">3.1.2.</span> <span class="nav-text">启动所有Redis 节点,并验证下进程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E6%A8%A1%E5%BC%8F%E5%90%AF%E5%8A%A8"><span class="nav-number">3.1.3.</span> <span class="nav-text">集群模式启动</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Redis-Cluster-%E6%B0%B4%E5%B9%B3%E6%89%A9%E5%AE%B9"><span class="nav-number">3.2.</span> <span class="nav-text">Redis Cluster 水平扩容</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Redis-Cluster-%E7%A7%BB%E9%99%A4%E6%89%A9%E5%AE%B9"><span class="nav-number">3.3.</span> <span class="nav-text">Redis Cluster 移除扩容</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Redis-Cluster-%E5%B0%8F%E7%9F%A5%E8%AF%86"><span class="nav-number">4.</span> <span class="nav-text">Redis Cluster 小知识</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Redis-%E9%9B%86%E7%BE%A4%E9%80%89%E4%B8%BE%E5%8E%9F%E7%90%86"><span class="nav-number">4.1.</span> <span class="nav-text">Redis 集群选举原理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%80%89%E4%B8%BE"><span class="nav-number">4.1.1.</span> <span class="nav-text">选举</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%91%E8%B5%B7FAILOVER-AUTH-REQUEST%E5%B9%BF%E6%92%AD%E7%9A%84%E6%97%B6%E6%9C%BA"><span class="nav-number">4.1.2.</span> <span class="nav-text">发起FAILOVER_AUTH_REQUEST广播的时机</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Redis-%E9%81%BF%E5%85%8D%E8%84%91%E8%A3%82%E9%97%AE%E9%A2%98"><span class="nav-number">4.2.</span> <span class="nav-text">Redis 避免脑裂问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Redis-Cluster-%E8%87%B3%E5%B0%91%E9%9C%80%E8%A6%813%E4%B8%AAMaster%E8%8A%82%E7%82%B9-%E5%B9%B6%E4%B8%94%E6%8E%A8%E8%8D%90%E8%8A%82%E7%82%B9%E6%95%B0%E4%B8%BA%E5%A5%87%E6%95%B0"><span class="nav-number">4.3.</span> <span class="nav-text">Redis Cluster 至少需要3个Master节点,并且推荐节点数为奇数</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">zhangwenhao</p>
  <div class="site-description" itemprop="description">告诉自己可以做好，即使是新事物，也一样可以做好</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">27</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">22</span>
        <span class="site-state-item-name">categories</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zhangwenhao</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
